---
title: 插件加载
icon: upload
tab:
  - 开发
  - 插件
  - 加载
---

本章介绍 Yunzai 如何识别和加载插件，帮助开发者理解插件的生命周期以及加载机制，方便开发与调试。

## 插件加载概览

Yunzai 插件加载大致分为以下步骤：

1. **扫描插件目录**  
   - 默认扫描 `plugins` 目录下的所有文件夹。
   - 支持子目录和多层插件结构。
   - 支持 JS 和 TS（编译后 JS）插件。

2. **加载模块**  
   - 加载 `apps` / `modules` 下的功能单元。
   - 每个功能单元需导出 `class` 或指定接口供 Yunzai 注册。

3. **注册功能**  
   - 将功能单元注册到 Yunzai 核心系统。
   - 系统为每个模块分配事件、命令、权限等。

<!-- 4. **加载配置**  
   - 加载插件的用户配置 `config`。
   - 初始化默认配置 `default_config` 并合并用户自定义配置。
   - 保证插件在首次加载时即可使用。

5. **插件初始化**  
   - 执行插件入口的初始化方法（如 `onLoad`、`init`）。
   - 初始化过程中可注册事件监听、定时任务等。

---

## 加载顺序与优先级

Yunzai 在插件加载时会考虑以下优先级：

| 步骤                 | 说明 |
| -------------------- | ---- |
| 核心模块先加载       | 保证系统基础能力可用 |
| JS/TS 功能模块加载   | 按目录或文件顺序 |
| 配置文件加载         | 默认配置先，用户配置后 |
| 初始化方法执行       | 模块最终生效 |

> 注意：如果插件依赖其他插件或库，确保依赖插件先加载，否则可能报错。

---

## 插件热加载

- 支持部分插件在运行时热加载，无需重启 Yunzai。
- 热加载流程：
  1. 监控 `plugins` 目录文件变化。
  2. 卸载旧模块。
  3. 重新加载新模块并注册。
- 注意：
  - 仅支持 JS 文件热更新，TS 插件需先编译。
  - 配置变更需触发重新加载或重启插件。

---

## 开发者注意事项

1. 插件必须导出标准接口或 class。
2. 避免在模块初始化时执行耗时操作。
3. 配置文件必须遵循约定结构。
4. 插件间依赖关系要明确，避免循环依赖。

---

## 可视化加载流程（示意）

```text
plugins/
 ├─ pluginA/
 │   ├─ index.js
 │   ├─ apps/
 │   └─ config/
 ├─ pluginB/
 │   └─ lib/
 │       └─ index.js
````

<!-- * 扫描 `plugins` → 解析入口 → 加载模块 → 注册功能 → 读取配置 → 初始化完成 -->

